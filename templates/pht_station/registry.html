{% extends "airflow/master.html" %}

{% block title %}PHT Tracker{% endblock %}

{% block head_css %}
{{ super() }}
<link href="{{ url_for("static", filename="dataTables.bootstrap.css") }}" rel="stylesheet" type="text/css" >
<link href="{{ url_for("static", filename="bootstrap-toggle.min.css") }}" rel="stylesheet" type="text/css">
{% endblock %}

{% block body %}
  <h2>Repositories</h2>

  <div id="main_content">
    <div class="row">
      <div class="col-sm-2">
      </div>
      <div class="col-sm-10">
      </div>
    </div>
    <table id="pht_station_repositories"
           class="table table-striped table-bordered table-hover">
        <thead>
            <tr>
                <th>Id</th>
                <th>Repository</th>
                <th>Description</th>
            </tr>
        </thead>
        <tbody>
        {% for repo in repos %}
            <tr>
                <td class="text-center">{{ repo.id }}</td>
                <td>{{ repo.name }}</td>
                <td class="text-center">{{ repo.description }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
  </div>

 <h2>Tags</h2>
    <table id="pht_station_tags"
           class="table table-striped table-bordered table-hover">
        <thead>
            <tr>
                <th>Name</th>
                <th>Digest</th>
                <th>Size</th>
                <th>Architecture</th>
                <th>OS</th>
                <th>Author</th>
                <th>Created</th>
                <th>Links</th>
            </tr>
        </thead>
    </table>
{% endblock %}

{% block tail %}
  {{ super() }}
  <script src="{{ url_for('static', filename='d3.v3.min.js') }}"></script>
  <script src="{{ url_for('static', filename='jquery.dataTables.min.js') }}"></script>
  <script src="{{ url_for('static', filename='bootstrap-toggle.min.js') }}"></script>
  <script src="{{ url_for('static', filename='bootstrap3-typeahead.min.js') }}"></script>
    <script>
    // TODO Refactor
    let selectedRepo = undefined;
    $(function(){
      const repos_table = $('#pht_station_repositories').DataTable({ select: true });
      let tags_table = $('#pht_station_tags').DataTable();
      tags_table.on('draw.dt', function () {
            tags_table.rows().every( function ( rowIdx, tableLoop, rowLoop ) {
                const {name, digest} = this.data();
                const links = this.node().lastChild;
                links.innerHTML = `<a href="{{ url_for('registry.train')}}"
                   onclick="return confirmTrain('${name}', '${digest}')">
                    <span class="glyphicon glyphicon-play-circle" aria-hidden="true" data-original-title="Trigger Dag">
                    </span>
                </a>`
        });
      });

      // Click handler for rows on the 'repositories' table
      $('#pht_station_repositories tbody').on('click', 'tr', function() {

          // Select row visually
         // if ( ! $(this).hasClass('selected')) {
         //   repos_table.$('tr.selected').removeClass('selected');
         //   $(this).addClass('selected');
         // }

         selectedRepo = repos_table.row(this).data()[1];
         tags_table.destroy();
         tags_table = $('#pht_station_tags').DataTable({
             ajax: {
                 url: "{{ url_for('registry.get_repository')}}" + `/${selectedRepo}/tag`,
                 dataSrc: 'tags'
             },
             columns: [
                 {"data": "name"},
                 {"data": "digest"},
                 {"data": "size"},
                 {"data": "architecture"},
                 {"data": "os"},
                 {"data": "author"},
                 {"data": "created"},
                 {"defaultContent": ""} // For the links
             ]
         });

      });
    });

    function confirmTrain(tag, digest){
        if (confirm("Are you sure?")) {
            const params = {
                tag, digest, repo: selectedRepo
            };
            $.ajax({
                type: "POST",
                url: "{{ url_for('registry.train') }}",
                dataType: 'json',
                async: false,
                contentType: 'application/json',
                data: JSON.stringify(params),
                success: () => alert('Successfully accepted train!')
            })
        }
        // prevents following the link in <a> tag
        return false;
    }
    </script>
{% endblock %}
